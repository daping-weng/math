<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>3D Plabic Graph Calculator</title>
        <!-- <link rel="icon" href="plat_trefoil.png" type="image/icon type">-->
        <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
    </head>
    <style>
        #canvas_column {
            float: left;
            width: 1000px;
            padding: 10px;
            display:table-cell;
        }

        #output {
            float: left;
            padding: 10px;
            position: absolute;
            left: 850px;
            top: 500px;
            right: 0px;
            overflow-y: auto;
            overflow-x: auto;
            display:table-cell;
        }
    </style>
    <body>
        <div class="row">
            <div class="column">
                <form>
                    &nbsp;<label for="N">N =</label> <input type="text" id="N" name="N" value="4" size="1"> &nbsp; &nbsp;
                    <label for="braid">braid word</label> &nbsp; <input type="text" id="braid" name="braid" value="2,3,1,-1,2,-2,3,-1,1,3,2,-3"> &nbsp; &nbsp;
                    <label for="u">u =</label> <input type="text" id="u" name="u" value="2,1"> &nbsp; &nbsp;
                    <label for="plabic">3d plabic graph</label> <input type="checkbox" id="plabic" name="plabic" value="yes" checked> &nbsp; &nbsp;
                    <label for="weave">T-shifted weave</label> <input type="checkbox" id="weave" name="weave" value="no" unchecked> &nbsp; &nbsp;
                    <label for="hdisplay">display h = y - x</label> <input type="checkbox" id="hdisplay" name="hdisplay" value="no" unchecked> &nbsp; &nbsp;
                    <!-- <label for="latex">LaTeX</label> &nbsp; <input type="checkbox" id="latex" name="latex" value="yes" checked>-->
                    <br>
                </form>
                <br>
                    &nbsp;<button type="button" onclick="draw()">Draw</button> &nbsp; &nbsp;
                    <button type="button" onclick="cross_section()">Cross-Section</button>&nbsp; &nbsp;
                    <label for="weave_color">weave color</label> &nbsp; <input type="text" id="weave_color" name="weave_color" value="blue,red,green,purple,yellow,brown" size="40">
                <br>
                <br>
            </div>
            <div id="canvas_column">
                &nbsp; <label for="yproj">yz-projection (red):</label>
                <br>
                <br>
                <canvas id="yproj" width="1000" height="360" style="border:1px solid #000000;"></canvas>
                <br>
                <br>
                &nbsp; <label for="xproj">xz-projection (blue):</label>
                <br>
                <br>
                <canvas id="xproj" width="1000" height="360" style="border:1px solid #000000;"></canvas>
                <br>
                <br>
                &nbsp; <label for="cross_section">cross-section:</label>
                <br>
                <canvas id="cross_section" width="480" height="480"></canvas>
            </div>
        </div>
    </body>
    <script src = "cross_section.js"></script>
    <script>
        var yproj = document.getElementById("yproj");
        var ydraw = yproj.getContext("2d");
        var xproj = document.getElementById("xproj");
        var xdraw = xproj.getContext("2d");
        var horizontal_spacing = 0;
        var vertical_spacing = 0;
        var hdisplay = false;
        var listener = false;
        var mode = 0;
        var cs = document.getElementById("cross_section");
        var csdraw = cs.getContext("2d");
        var grid_spacing = 0;
        var num = 0;
        var word = [];
        var crossing_position =[];
        var t = 0;
        var animation = null;
        var time_run = 0;
        var color_list = null;
        var gap = 0;
        var plabic = true;
        var weave = false;

        function bridge_yproj_column(column_num, CS) {
            var letter = word[column_num];
            for (var i=0; i<num; i++) {
                ydraw.beginPath();
                ydraw.strokeStyle = "black";
                ydraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i));
                ydraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i));
                ydraw.stroke();
                ydraw.closePath();
                if (hdisplay) {
                    h = CS.height();
                    ydraw.fillStyle = "red";
                    ydraw.fillText(String(column_sum(h,i)),horizontal_spacing*(column_num+2),vertical_spacing*(num-i)-10);
                }
            }
            var vertices = CS.bridge(letter);
            var b = vertices[0][1];
            var w = vertices[1][1];
            ydraw.beginPath();
            ydraw.strokeStyle = "black";
            ydraw.moveTo(horizontal_spacing*(column_num+1.5), vertical_spacing*(num+1-b));
            ydraw.lineTo(horizontal_spacing*(column_num+1.5), vertical_spacing*(num+1-w));
            ydraw.stroke();
            ydraw.closePath();
            ydraw.beginPath();
            ydraw.strokeStyle = "black";
            ydraw.fillStyle = "white";
            ydraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-w),5,0,2*Math.PI,false);
            ydraw.stroke();
            ydraw.fill();
            ydraw.closePath();
            ydraw.beginPath();
            ydraw.fillStyle = "black";
            ydraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-b),5,0,2*Math.PI,false);
            ydraw.stroke();
            ydraw.fill();
            ydraw.closePath();
            for (var i=w+1;i<b;i++) {
                ydraw.beginPath();
                ydraw.strokeStyle = "white";
                ydraw.fillStyle = "white";
                ydraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-i),5,0,2*Math.PI,false);
                ydraw.stroke();
                ydraw.fill();
                ydraw.closePath();
                if (column_sum(CS.height(),i-1)< column_sum(CS.height(),b-1)) {
                    ydraw.beginPath();
                    ydraw.strokeStyle = "black";
                    ydraw.moveTo(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-i)-6);
                    ydraw.lineTo(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-i)+6);
                    ydraw.stroke();
                    ydraw.closePath();
                } else {
                    ydraw.beginPath();
                    ydraw.strokeStyle = "black";
                    ydraw.moveTo(horizontal_spacing*(column_num+1.5)-6,vertical_spacing*(num+1-i));
                    ydraw.lineTo(horizontal_spacing*(column_num+1.5)+6,vertical_spacing*(num+1-i));
                    ydraw.stroke();
                    ydraw.closePath();
                }
            }
        }

        function bridge_xproj_column(column_num, CS) {
            var letter = word[column_num];
            for (var i=0; i<num; i++) {
                xdraw.beginPath();
                xdraw.strokeStyle = "black";
                xdraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i));
                xdraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i));
                xdraw.stroke();
                xdraw.closePath();
                if (hdisplay) {
                    h = CS.height();
                    xdraw.fillStyle = "red";
                    xdraw.fillText(String(row_sum(h,i)),horizontal_spacing*(column_num+2),vertical_spacing*(num-i)-10);
                }
            }
            var vertices = CS.bridge(letter);
            var b = vertices[0][0];
            var w = vertices[1][0];
            xdraw.beginPath();
            xdraw.strokeStyle = "black";
            xdraw.moveTo(horizontal_spacing*(column_num+1.5), vertical_spacing*(num+1-b));
            xdraw.lineTo(horizontal_spacing*(column_num+1.5), vertical_spacing*(num+1-w));
            xdraw.stroke();
            xdraw.closePath();
            xdraw.beginPath();
            xdraw.strokeStyle = "black";
            xdraw.fillStyle = "white";
            xdraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-w),5,0,2*Math.PI,false);
            xdraw.stroke();
            xdraw.fill();
            xdraw.closePath();
            xdraw.beginPath();
            xdraw.fillStyle = "black";
            xdraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-b),5,0,2*Math.PI,false);
            xdraw.stroke();
            xdraw.fill();
            xdraw.closePath();
            for (var i=b+1;i<w;i++) {
                xdraw.beginPath();
                xdraw.strokeStyle = "white";
                xdraw.fillStyle = "white";
                xdraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-i),5,0,2*Math.PI,false);
                xdraw.stroke();
                xdraw.fill();
                xdraw.closePath();
                if (row_sum(CS.height(),i-1) < row_sum(CS.height(),b-1)) {
                    xdraw.beginPath();
                    xdraw.strokeStyle = "black";
                    xdraw.moveTo(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-i)-6);
                    xdraw.lineTo(horizontal_spacing*(column_num+1.5),vertical_spacing*(num+1-i)+6);
                    xdraw.stroke();
                    xdraw.closePath();
                } else {
                    xdraw.beginPath();
                    xdraw.strokeStyle = "black";
                    xdraw.moveTo(horizontal_spacing*(column_num+1.5)-6,vertical_spacing*(num+1-i));
                    xdraw.lineTo(horizontal_spacing*(column_num+1.5)+6,vertical_spacing*(num+1-i));
                    xdraw.stroke();
                    xdraw.closePath();
                }
            }
        }


        function crossing_yproj_column(column_num, CS) {
            var letter = word[column_num];
            for (var i=0; i<num; i++) {
                if (i == letter-1 ) {
                    ydraw.beginPath();
                    ydraw.strokeStyle = "black";
                    ydraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i-1));
                    ydraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i));
                    ydraw.stroke();
                    ydraw.closePath();
                    ydraw.beginPath();
                    ydraw.strokeStyle = "white";
                    ydraw.fillStyle = "white";
                    ydraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num-i-0.5),5,0,2*Math.PI,false);
                    ydraw.stroke();
                    ydraw.fill();
                    ydraw.closePath();
                } else if (i == letter) {
                    ydraw.beginPath();
                    ydraw.strokeStyle = "black";
                    ydraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i+1));
                    ydraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i));
                    ydraw.stroke();
                    ydraw.closePath();
                } else {
                    ydraw.beginPath();
                    ydraw.strokeStyle = "black";
                    ydraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i));
                    ydraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i));
                    ydraw.stroke();
                    ydraw.closePath();
                }
                if (hdisplay) {
                    h = CS.height();
                    ydraw.fillStyle = "red";
                    ydraw.fillText(String(column_sum(h,i)),horizontal_spacing*(column_num+2),vertical_spacing*(num-i)-10);
                }
            }
        }

        

        function crossing_xproj_column(column_num, CS) {
            var letter = word[column_num];
            for (var i=0; i<num; i++) {
                if (i == -letter-1 ) {
                    xdraw.beginPath();
                    xdraw.strokeStyle = "black";
                    xdraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i));
                    xdraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i-1));
                    xdraw.stroke();
                    xdraw.closePath();
                    xdraw.beginPath();
                    xdraw.strokeStyle = "white";
                    xdraw.fillStyle = "white";
                    xdraw.arc(horizontal_spacing*(column_num+1.5),vertical_spacing*(num-i-0.5),5,0,2*Math.PI,false);
                    xdraw.stroke();
                    xdraw.fill();
                    xdraw.closePath();
                } else if (i == -letter) {
                    xdraw.beginPath();
                    xdraw.strokeStyle = "black";
                    xdraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i));
                    xdraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i+1));
                    xdraw.stroke();
                    xdraw.closePath();
                } else {
                    xdraw.beginPath();
                    xdraw.strokeStyle = "black";
                    xdraw.moveTo(horizontal_spacing*(column_num+1),vertical_spacing*(num-i));
                    xdraw.lineTo(horizontal_spacing*(column_num+2),vertical_spacing*(num-i));
                    xdraw.stroke();
                    xdraw.closePath();
                }
                if (hdisplay) {
                    h = CS.height();
                    xdraw.fillStyle = "red";
                    xdraw.fillText(String(row_sum(h,i)),horizontal_spacing*(column_num+2),vertical_spacing*(num-i)-10);
                }
            }
        }

        function perm_length(p) {
            var length = 0;
            for (var i=0;i<p.length;i++) {
                for (var j=i+1;j<p.length;j++) {
                    if (p[i]>p[j]) {
                        length++;
                    }
                }
            }
            return(length);
        }

        function convert_perm(n, w) {
            var tuple = []
            for (var i=0;i<n;i++) {
                tuple.push(i+1);
            }
            for (var i=0;i<w.length;i++) {
                tuple[w[i]-1] = tuple[w[i]]+tuple[w[i]-1];
                tuple[w[i]] = tuple[w[i]-1]-tuple[w[i]];
                tuple[w[i]-1] = tuple[w[i]-1]-tuple[w[i]];
            }
            return(tuple);
        }

        function length_decrease(p, i) {
            var q = [...p];
            if (i>0) {
                q[i-1] = q[i-1] + q[i];
                q[i] = q[i-1] - q[i];
                q[i-1] = q[i-1] - q[i];
                if (perm_length(q)<perm_length(p)) {
                    return([true,q]);
                } else {
                    return([false,p]);
                }
            } else if (i<0) {
                i = -i;
                var a = q.indexOf(i);
                var b = q.indexOf(i+1);
                q[a] = i+1;
                q[b] = i;
                if (perm_length(q)<perm_length(p)) {
                    return([true,q]);
                } else {
                    return([false,p]);
                }
            }
        }

        function initial_weave_word(num) {
            var coord = [];
            var color_seq = [];
            var color_term = [];
            for (var i=0;i<num;i++) {
                coord.push([i+1,i+1]);
                if (i>0) {
                    color_term = [];
                    for (var j=0;j<num-i;j++) {
                        color_term.push([j+1,j+i+1]);
                    }
                    color_seq.push([...color_term]);
                }
            }
            return(new weave(coord,color_seq));
        }

        function draw_plabic() {
            CS = initialCrossSection(num);
            for (var i=0; i<word.length; i++) {
                if (crossing_position.includes(i)) {
                    CS.switch(word[i]);
                    crossing_yproj_column(i, CS);
                    crossing_xproj_column(i, CS);
                } else {
                    bridge_yproj_column(i, CS);
                    bridge_xproj_column(i, CS);
                }
            }
            if (hdisplay) {
                for (var i=0;i<num;i++) {
                    ydraw.fillStyle = "red";
                    ydraw.fillText("0",horizontal_spacing,vertical_spacing*(i+1)-10);
                    xdraw.fillStyle = "red";
                    xdraw.fillText("0",horizontal_spacing,vertical_spacing*(i+1)-10);
                }
            }
        }

        function get_location(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            var index = Math.floor((evt.clientX-rect.left)/horizontal_spacing);
            console.log(index);
            return(index);
        }

        function cs_xcoord(coord,spacing) {
            return((coord[0]+coord[1])*spacing);
        }
        function cs_ycoord(coord, spacing) {
            return((num+coord[0]-coord[1])*spacing);
        }

        function draw_cross_section(left_cs_vertices, right_cs_vertices, index) {
            csdraw.clearRect(0, 0, 480, 480);
            grid_spacing = 240/(num+1);
            for (var i=0;i<num;i++) {
                csdraw.beginPath();
                csdraw.strokeStyle = "silver";
                csdraw.moveTo(cs_xcoord([1,i+1],grid_spacing),cs_ycoord([1,i+1],grid_spacing));
                csdraw.lineTo(cs_xcoord([num,i+1],grid_spacing), cs_ycoord([num,i+1], grid_spacing));
                csdraw.stroke();
                csdraw.closePath();
                csdraw.beginPath();
                csdraw.strokeStyle = "silver";
                csdraw.moveTo(cs_xcoord([i+1,1],grid_spacing),cs_ycoord([i+1,1],grid_spacing));
                csdraw.lineTo(cs_xcoord([i+1,num],grid_spacing), cs_ycoord([i+1,num], grid_spacing));
                csdraw.stroke();
                csdraw.closePath();
                csdraw.beginPath();
                csdraw.fillStyle = "silver";
                csdraw.fillText(String(i+1),cs_xcoord([i+1,1],grid_spacing)-10, cs_ycoord([i+1,1],grid_spacing)+3);
                csdraw.closePath();
                if (i>0) {
                    csdraw.beginPath();
                    csdraw.fillStyle = "silver";
                    csdraw.fillText(String(i+1),cs_xcoord([1,i+1],grid_spacing)-10, cs_ycoord([1,i+1],grid_spacing)+3);
                    csdraw.closePath();
                }
            }
            for(var i=0;i<num;i++) {
                csdraw.beginPath();
                csdraw.strokeStyle = "black";
                csdraw.moveTo(cs_xcoord([0.5, left_cs_vertices[i][1]], grid_spacing)*(50-t)/50+cs_xcoord([0.5,right_cs_vertices[i][1]], grid_spacing)*t/50,cs_ycoord([0.5,left_cs_vertices[i][1]], grid_spacing)*(50-t)/50+cs_ycoord([0.5,right_cs_vertices[i][1]], grid_spacing)*t/50);
                csdraw.lineTo(cs_xcoord(left_cs_vertices[i], grid_spacing)*(50-t)/50+cs_xcoord(right_cs_vertices[i], grid_spacing)*t/50,cs_ycoord(left_cs_vertices[i], grid_spacing)*(50-t)/50+cs_ycoord(right_cs_vertices[i], grid_spacing)*t/50);
                csdraw.lineTo(cs_xcoord([left_cs_vertices[i][0],num+0.5], grid_spacing)*(50-t)/50+cs_xcoord([right_cs_vertices[i][0],num+0.5], grid_spacing)*t/50,cs_ycoord([left_cs_vertices[i][0],num+0.5], grid_spacing)*(50-t)/50+cs_ycoord([right_cs_vertices[i][0],num+0.5], grid_spacing)*t/50);
                csdraw.stroke();
                csdraw.closePath();
                csdraw.beginPath();
                if (right_cs_vertices[i][1] == word[index-1] || right_cs_vertices[i][1] == word[index-1]+1 || right_cs_vertices[i][0] == -word[index-1] || right_cs_vertices[i][0] == -word[index-1]+1) {
                    csdraw.fillStyle = "red";
                    csdraw.strokeStyle = "red";
                } else {
                    csdraw.fillStyle = "black";
                    csdraw.strokeStyle = "black";
                }
                csdraw.arc(cs_xcoord(left_cs_vertices[i], grid_spacing)*(50-t)/50+cs_xcoord(right_cs_vertices[i],grid_spacing)*t/50,cs_ycoord(left_cs_vertices[i], grid_spacing)*(50-t)/50+cs_ycoord(right_cs_vertices[i],grid_spacing)*t/50,3,0,2*Math.PI,false);
                csdraw.fill();
                csdraw.stroke();
                csdraw.fillText(String(i+1), cs_xcoord(left_cs_vertices[i], grid_spacing)*(50-t)/50+cs_xcoord(right_cs_vertices[i],grid_spacing)*t/50,cs_ycoord(left_cs_vertices[i], grid_spacing)*(50-t)/50+cs_ycoord(right_cs_vertices[i],grid_spacing)*t/50+10);
                csdraw.closePath();
            }
            t += 1;
            t = t%51;
            time_run += 1;
            if (time_run == 6000) {
                clearInterval(animation);
                time_run = 0;
            }
        }

        function mouseClick(index) {
            if (mode == 1) {
                CS = initialCrossSection(num);
                for (var i=0;i<index-1;i++) {
                    if (crossing_position.includes(i)) {
                        CS.switch(word[i]);
                    }                    
                }
                var left_cs_vertices = [];
                for (var i=1;i<num+1;i++) {
                    left_cs_vertices.push([...CS.location(i)]);
                }
                if (crossing_position.includes(index-1)) {
                    CS.switch(word[index-1]);
                }
                var right_cs_vertices = [];
                for (var i=1;i<num+1;i++) {
                    right_cs_vertices.push([...CS.location(i)]);
                }
                //console.log(left_cs_vertices,right_cs_vertices);
                t=0;
                time_run = 0;
                clearInterval(animation);
                animation = setInterval(draw_cross_section, 60, left_cs_vertices, right_cs_vertices, index);
            }
        }

        function cross_section() {
            mode = 1;
            clearInterval(animation);
            if (!listener) {
                yproj.addEventListener(
                    "click",function(evt){
                        var index = get_location(yproj, evt);
                        if (index != null) {
                            mouseClick(index);
                        }
                    }
                )
                xproj.addEventListener(
                    "click",function(evt){
                        var index = get_location(xproj, evt);
                        if (index != null) {
                            mouseClick(index);
                        }
                    }
                )
                listener = true;
            }
        }

        function search_array(A,a) {
            for (var i=0;i<A.length;i++) {
                for (var j=0;j<A[i].length;j++) {
                    if (A[i][j] != a[j]) {
                        break;
                    } else if (j==A[i].length-1) {
                        return(i);
                    }
                }
            }
            return(-1);
        }

        function draw_y_weave() {
            CS = initialCrossSection(num);
            for (var k=0;k<word.length;k++) {
                if (crossing_position.includes(k)) {
                    var left_crossing_matrix = JSON.parse(JSON.stringify(CS.crossingMatrix));
                    var Tshift_seq = CS.crossingTshift(word[k]);
                    if (word[k] > 0) {
                        for (var i=0;i<num;i++) {
                            for (var j=0;j<num;j++) {
                                ydraw.beginPath();
                                ydraw.strokeStyle = color_list[left_crossing_matrix[i][j]-1];
                                ydraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                var index = search_array(Tshift_seq, [i+1,j+1]);
                                if (index == 0 && Tshift_seq.length == 1) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num+0.5));
                                } else if (index == 0) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][1]+2)+gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                } else if (index != -1) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5)-gap, vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j+1)+gap*left_crossing_matrix[i+1][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5)+gap, vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.stroke();
                                    ydraw.closePath();
                                    ydraw.beginPath();
                                    ydraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j+1)+gap*left_crossing_matrix[i+1][j]);
                                    if (index < Tshift_seq.length -1) {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][1]+2)+gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                    } else {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num+0.5));
                                    }
                                } else if (index == -1 && left_crossing_matrix[i][j]>0) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    if (j+1 == Tshift_seq[0][1]) {
                                        ydraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-j+1)+gap*left_crossing_matrix[i][j]);
                                    } else {
                                        ydraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    }
                                }
                                ydraw.stroke();
                                ydraw.closePath();
                            }
                            
                        }
                    } else if (word[k] < 0) {
                        for (var i=0;i<num;i++) {
                            for (var j=0;j<num;j++) {
                                ydraw.beginPath();
                                ydraw.strokeStyle = color_list[left_crossing_matrix[i][j]-1];
                                ydraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                var index = search_array(Tshift_seq, [i+1,j+1]);
                                if (index == 0 && Tshift_seq.length == 1) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*0.5);
                                } else if (index == 0) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][1]+1)+gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                } else if (index != -1) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5)-gap, vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*left_crossing_matrix[i+1][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+1.5)+gap, vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                    ydraw.stroke();
                                    ydraw.closePath();
                                    ydraw.beginPath();
                                    ydraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*left_crossing_matrix[i+1][j]);
                                    if (index < Tshift_seq.length -1) {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][1]+1)+gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                    } else {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*0.5);
                                    }
                                } else if (index == -1 && left_crossing_matrix[i][j]>0) {
                                    ydraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-j)+gap*left_crossing_matrix[i][j]);
                                }
                                ydraw.stroke();
                                ydraw.closePath();
                            }
                            
                        }
                    }
                } else {
                    var Tshift_seq = CS.bridgeTshift(word[k]);
                    for (var i=0;i<num;i++) {
                        for (var j=0;j<num;j++) {
                            var index = search_array(Tshift_seq, [i+1,j+1]);
                            if (index != -1){
                                ydraw.beginPath();
                                ydraw.strokeStyle = color_list[CS.crossingMatrix[i][j]-1];
                                ydraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-j)+gap*CS.crossingMatrix[i][j]);
                                ydraw.lineTo(horizontal_spacing*(k+1.5)-gap, vertical_spacing*(num-j)+gap*CS.crossingMatrix[i][j]);
                                if (word[k]>0) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j+1)+gap*Math.max(0,CS.crossingMatrix[i][j-1]));
                                } else if (word[k]<0) {
                                    ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*Math.max(0,CS.crossingMatrix[i+1][j]));
                                }
                                ydraw.lineTo(horizontal_spacing*(k+1.5)+gap, vertical_spacing*(num-j)+gap*CS.crossingMatrix[i][j]);
                                ydraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-j)+gap*CS.crossingMatrix[i][j]);
                                ydraw.stroke();
                                ydraw.closePath();
                                ydraw.beginPath();
                                if (word[k]>0) {
                                    ydraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j+1)+gap*Math.max(0,CS.crossingMatrix[i][j-1]));
                                    if (index < Tshift_seq.length-1) {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j+1)+gap*Math.max(0,CS.crossingMatrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]));
                                    } else {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num+0.5));
                                    }
                                } else if (word[k]<0) {
                                    ydraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-j)+gap*Math.max(0,CS.crossingMatrix[i+1][j]));
                                    if (index < Tshift_seq.length-1) {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][1]+1)+gap*Math.max(0,CS.crossingMatrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]));
                                    } else {
                                        ydraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*0.5);
                                    }
                                }
                                ydraw.stroke();
                                ydraw.closePath();
                            } else if (CS.crossingMatrix[i][j]>0) {
                                ydraw.beginPath();
                                ydraw.strokeStyle = color_list[CS.crossingMatrix[i][j]-1];
                                ydraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-j)+gap*CS.crossingMatrix[i][j]);
                                ydraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-j)+gap*CS.crossingMatrix[i][j]);
                                ydraw.stroke();
                                ydraw.closePath();
                                ydraw.beginPath();
                            }
                            
                        }
                    }
                }
            }
        }

        function draw_x_weave() {
            CS = initialCrossSection(num);
            for (var k=0;k<word.length;k++) {
                if (crossing_position.includes(k)) {
                    var left_crossing_matrix = JSON.parse(JSON.stringify(CS.crossingMatrix));
                    var Tshift_seq = CS.crossingTshift(word[k]);
                    if (word[k] < 0) {
                        for (var i=0;i<num;i++) {
                            for (var j=0;j<num;j++) {
                                xdraw.beginPath();
                                xdraw.strokeStyle = color_list[left_crossing_matrix[i][j]-1];
                                xdraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                var index = search_array(Tshift_seq, [i+1,j+1]);
                                if (index == 0 && Tshift_seq.length == 1) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*0.5);
                                } else if (index == 0) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][0])-gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                } else if (index != -1) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5)-gap, vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i-1)-gap*left_crossing_matrix[i+1][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5)+gap, vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.stroke();
                                    xdraw.closePath();
                                    xdraw.beginPath();
                                    xdraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i-1)-gap*left_crossing_matrix[i+1][j]);
                                    if (index < Tshift_seq.length -1) {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][0])-gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                    } else {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*0.5);
                                    }
                                } else if (index == -1 && left_crossing_matrix[i][j]>0) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    if (i+1 == Tshift_seq[0][0]) {
                                        xdraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-i-1)-gap*left_crossing_matrix[i][j]);
                                    } else {
                                        xdraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    }
                                }
                                xdraw.stroke();
                                xdraw.closePath();
                            }
                            
                        }
                    } else if (word[k] > 0) {
                        for (var i=0;i<num;i++) {
                            for (var j=0;j<num;j++) {
                                xdraw.beginPath();
                                xdraw.strokeStyle = color_list[left_crossing_matrix[i][j]-1];
                                xdraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                var index = search_array(Tshift_seq, [i+1,j+1]);
                                if (index == 0 && Tshift_seq.length == 1) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num+0.5));
                                } else if (index == 0) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][0]+1)-gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                } else if (index != -1) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5)-gap, vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*left_crossing_matrix[i+1][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+1.5)+gap, vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                    xdraw.stroke();
                                    xdraw.closePath();
                                    xdraw.beginPath();
                                    xdraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*left_crossing_matrix[i+1][j]);
                                    if (index < Tshift_seq.length -1) {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][0]+1)-gap*left_crossing_matrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]);
                                    } else {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num+0.5));
                                    }
                                } else if (index == -1 && left_crossing_matrix[i][j]>0) {
                                    xdraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-i)-gap*left_crossing_matrix[i][j]);
                                }
                                xdraw.stroke();
                                xdraw.closePath();
                            }
                            
                        }
                    }
                } else {
                    var Tshift_seq = CS.bridgeTshift(word[k]);
                    for (var i=0;i<num;i++) {
                        for (var j=0;j<num;j++) {
                            var index = search_array(Tshift_seq, [i+1,j+1]);
                            if (index != -1){
                                xdraw.beginPath();
                                xdraw.strokeStyle = color_list[CS.crossingMatrix[i][j]-1];
                                xdraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-i)-gap*CS.crossingMatrix[i][j]);
                                xdraw.lineTo(horizontal_spacing*(k+1.5)-gap, vertical_spacing*(num-i)-gap*CS.crossingMatrix[i][j]);
                                if (word[k]<0) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i-1)-gap*Math.max(0,CS.crossingMatrix[i+1][j]));
                                } else if (word[k]>0) {
                                    xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*Math.max(0,CS.crossingMatrix[i][j-1]));
                                }
                                xdraw.lineTo(horizontal_spacing*(k+1.5)+gap, vertical_spacing*(num-i)-gap*CS.crossingMatrix[i][j]);
                                xdraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-i)-gap*CS.crossingMatrix[i][j]);
                                xdraw.stroke();
                                xdraw.closePath();
                                xdraw.beginPath();
                                if (word[k]<0) {
                                    xdraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i-1)-gap*Math.max(0,CS.crossingMatrix[i+1][j]));
                                    if (index < Tshift_seq.length-1) {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i-1)-gap*Math.max(0,CS.crossingMatrix[Tshift_seq[index+1][0]][Tshift_seq[index+1][1]-1]));
                                    } else {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*0.5);
                                    }
                                } else if (word[k]>0) {
                                    xdraw.moveTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-i)-gap*Math.max(0,CS.crossingMatrix[i][j-1]));
                                    if (index < Tshift_seq.length-1) {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num-Tshift_seq[index+1][0]+1)-gap*Math.max(0,CS.crossingMatrix[Tshift_seq[index+1][0]-1][Tshift_seq[index+1][1]-2]));
                                    } else {
                                        xdraw.lineTo(horizontal_spacing*(k+1.5), vertical_spacing*(num+0.5));
                                    }
                                }
                                xdraw.stroke();
                                xdraw.closePath();
                            } else if (CS.crossingMatrix[i][j]>0) {
                                xdraw.beginPath();
                                xdraw.strokeStyle = color_list[CS.crossingMatrix[i][j]-1];
                                xdraw.moveTo(horizontal_spacing*(k+1), vertical_spacing*(num-i)-gap*CS.crossingMatrix[i][j]);
                                xdraw.lineTo(horizontal_spacing*(k+2), vertical_spacing*(num-i)-gap*CS.crossingMatrix[i][j]);
                                xdraw.stroke();
                                xdraw.closePath();
                                xdraw.beginPath();
                            }
                            
                        }
                    }
                }
            }
        }

        function draw() {
            mode = 0;
            clearInterval(animation);
            coord_seq = [];
            ydraw.clearRect(0, 0, 1000, 360);
            xdraw.clearRect(0, 0, 1000, 360);
            csdraw.clearRect(0, 0, 480, 480);
            //latex = document.getElementById("latex").checked;
            hdisplay = document.getElementById("hdisplay").checked;
            plabic = document.getElementById("plabic").checked;
            weave = document.getElementById("weave").checked;
            num = parseInt(document.getElementById("N").value);
            word = document.getElementById("braid").value.split(",");
            var codist = document.getElementById("u").value.split(",");
            if (codist[0] == '') {
                codist = [];
            }
            for(var i=0;i<word.length;i++) {
                word[i] = parseInt(word[i]);
                if (word[i]<=-num || word[i]>=num || word[i]==0) {
                    window.alert("The braid word is invalid.");
                    return;
                }
            }
            horizontal_spacing = 1000/(word.length+2);
            vertical_spacing = 360/(num+1);
            for (var i=0;i<codist.length;i++) {
                codist[i] = parseInt(codist[i]);
                if (codist[i]<=0 || codist[i]>=num) {
                    window.alert("The permutation u is invalid.");
                    return;
                }
            }
            var uperm = convert_perm(num, codist);
            crossing_position = [];
            for (var i=0;i<word.length;i++) {
                if (crossing_position.length == codist.length) {
                    break;
                } else if (length_decrease(uperm,word[word.length-1-i])[0]) {
                    crossing_position.push(word.length-i-1);
                    uperm = [...length_decrease(uperm,word[word.length-i-1])[1]];
                }
            }
            if (crossing_position.length<codist.length) {
                window.alert("The braid is not adapted to the u permutation.");
                return;
            }
            console.log(crossing_position);
            gap = vertical_spacing/num;
            color_list = document.getElementById("weave_color").value.split(",");
            if (plabic) {
                draw_plabic();
            }
            if (weave) {
                draw_y_weave();
                draw_x_weave();
            }
        }

    </script>
</html>